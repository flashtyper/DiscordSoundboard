<!DOCTYPE html>
<html>

<head profile="http://www.w3.org/2005/10/profile">
    <link rel="icon" type="image/png" href="oi-logo.png">
    <!-- Layout by Jona, made for github.com/Darkside138/DiscordSoundboard -->
    <!-- Feel free to use as fit -->
    <title>oi Soundboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
        integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.1/css/bootstrap.min.css"
        crossorigin="anonymous" />
    <link rel="stylesheet" href="soundboard.css">

</head>

<body class="bg-dark">
    <!-- Modal Reload -->
    <div id ="Modal" style="color: black" class="modal fade" id="reloadModal" tabindex="-1" role="dialog" aria-labelledby="reloadModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reloadModalLabel">Sound &Aumlnderungen</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Es wurden Sound &Aumlnderungen im Bot erkannt. Soll die Seite jetzt neu geladen werden?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Weg mit dem M&uumlll</button>
                    <button id="modalReloadButton" type="button" class="btn btn-primary">Seite neu laden</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal URL 403 - Age Verification -->
    <div id ="ModalURL403" style="color: black" class="modal fade" id="ModalURL403" tabindex="-1" role="dialog" aria-labelledby="ModalURL403Label"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalURL403Label">Fehler</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    This video requires age verification.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Schlie&szlig;en</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal URL 400 - Bad Request -->
    <div id ="ModalURL400" style="color: black" class="modal fade" id="ModalURL400" tabindex="-1" role="dialog" aria-labelledby="ModalURL400Label"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalURL400Label">Fehler</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    URL konnte nicht abgespielt werden. Siehe log f&uuml;r weitere Infos.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Schlie&szlig;en</button>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-expand navbar-dark bg-darker">
        <a class="navbar-brand" href="#"><img src="Sherlock_animated.gif" width="65px" height="60px"> oi-Soundbot Controls:</a>
        <ul class="navbar-nav mr-auto">
            <li class="control-item">
                <a id="random" class="nav-link" href="#">Zufall (DEFEKT)<i class="fas fa-fw fa-random"></i></a>
            </li>
            <li class="control-item">
                <a id="stop" class="nav-link" href="#">Stop <i class="fas fa-fw fa-stop"></i></a>
            </li>
            <li class="control-item">
                <a id="reload" class="nav-link" href="#">Reload <i class="fas fa-fw fa-sync"></i></a>
            </li>
            <li class="control-item">
                <a id="disconnect" class="nav-link" href="#">Disconnect <i class="fas fa-fw fa-phone-slash"></i></a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <input id="url-search" class="form-control" type="url-search" placeholder="URL eingeben...">
            </li>
            <li class="control-item">
                <a id="play-url" class="nav-link" href="#">Play! <i class="fas fa-fw fa-play"></i></a>
            </li>
            
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <input id="search" class="form-control" type="search" placeholder="Suche">
            </li>
            <li class="control-item">
                <select id="user" class="custom-select"></select>
            </li>
        </ul>
    </nav>

    <nav class="navbar navbar-expand navbar-dark bg-darker">
        <a class="navbar-brand" href="#"></a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul id="categories" class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-category="All">All</a>
                </li>
            </ul>
            <ul class="navbar-nav mr-auto">
                <li id="more" class="nav-item dropdown" style="display:none;">
                    <a class="nav-link dropdown-toggle" href="#" id="moreLabel" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                        More...
                    </a>
                    <div class="dropdown-menu" aria-labelledby="moreLabel">
                    </div>
                </li>
            </ul>

        </div>
    </nav>


    <div id="sounds" class="container-fluid p-3"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.1/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>


    <script type="text/javascript">
        $(function () {
            var category = 'All';
            var lastReload = 0;
            var intervalId;

            

            // Determine what categories to show in navigation and what categories to show in the more-dropdown
            function determineShownNavigation() {
                // Get available width for shown categories.
                // 275px extra for spacing, more-dropdown and buttons
                var availableWidth = window.innerWidth - $('.navbar-brand').width() - 30;
                console.log(availableWidth);
                var shouldSkip = false;
                $.each($('#categories li'), function (i, obj) {
                    var willFit = availableWidth - $(obj).width() > 0;
                    if (shouldSkip) willFit = false;
                    $(obj).toggle(willFit);
                    $('#more a[data-category="' + $(obj).find('a').data('category') + '"]').toggle(!willFit);
                    if (willFit) {
                        availableWidth -= $(obj).width();
                    } else {
                        shouldSkip = true;
                    }
                });
                $('#more').toggle($('#categories li:hidden').length > 0);
            }

            // Filter the list by category and search-term
            function filterSounds(search) {
                $('#sounds div').hide();
                $('#sounds div').filter(function () {
                    return (category === 'All' || $(this).data('category') === category) && (search == '' || $(this).text().toLowerCase().includes(search.toLowerCase()));
                }).show();
            }

            $(document).on('click', 'a[data-category]', function () {
                // Filter by category
                category = $(this).data('category');
                $('a[data-category]').removeClass('active');
                $('a[data-category="' + category + '"]').addClass('active');
                $('#more').toggleClass('active', $('a[data-category].active:visible').closest('#more').length > 0);
                $('#search').val('');
                filterSounds($('#search').val());
            }).on('input', '#search', function () {
                category = 'All';
                $('a[data-category]').removeClass('active');
                $('a[data-category="' + category + '"]').addClass('active');
                // Search sound by name
                filterSounds($(this).val());
            }).on('click', '#sounds div', function () {
                // Play sound
                $.ajax({
                    method: "POST",
                    url: "/bot/playFileInChannel?soundFileId=" + this.id + "&voiceChannelId=" + $('#user').val()
                });
            }).on('click', '#random', function () {
                // Play random sound
                $.ajax({
                    method: "POST",
                    url: "/bot/random?voiceChannelId=" + $('#user').val()
                });
            }).on('click', '#stop', function () {
                // Stop sound
                $.ajax({
                    method: "POST",
                    url: "/bot/stop?voiceChannelId=" + $('#user').val()
                    //url: "/bot/playFileInChannel?soundFileId=" + "Flashbang" + "&voiceChannelId=" + $('#user').val()
                    // Spielt die CSGO Flashbang ab, statt normal zu stoppen KEKW
                });
            }).on('click', '#play-url', function () {
            // Play URL via GUI
                $.ajax({
                    method: "POST",
                    url: "/bot/playUrlGUI?url=" + $('#url-search').val() + "&voiceChannelId=" + $('#user').val(),
                    statusCode: {
                            403: function(xhr) {
                              // Age Verification failed
                              console.log("Age Verification failed for: " + $('#url-search').val());
                              $('#ModalURL403').modal('show');
                            },
                            400: function(xhr) {
                              // irgendwas anderes ist kaputt
                              console.log("Oops something went wrong for: " + $('#url-search').val());
                              $('#ModalURL400').modal('show');
                            },
                            200: function(xhr) {
                                console.log("hat geklappt");
                            }
                    }
                });
                $('#url-search').val("");
            }).on('click', '#disconnect', function () {
                // Disconnects the Bot from all channels
                $.ajax({
                    method: "POST",
                    url: "/bot/disconnect"
                });
            }).on('click', '#reload', function () {
                // Reload Files
                $.ajax({
                    method: "POST",
                    url: "/bot/reload"
                });
            }).on('click', '#modalReloadButton', function () {
                location.reload();                
            }).on('change', '#rgb', function () {
                // Enable RGB
                $('body').toggleClass('bg-rgb', $('#rgb').is(':checked'));
            }).on('change', '#volume', function () {
                // Change volume
                $.ajax({
                    method: "POST",
                    url: "/bot/volume?volume=" + $(this).val() + "&username=" + $('#user').val()
                });
            }).on('show.bs.dropdown', '#settings', function () {
                // Get current volume when opening settings
                $.ajax({
                    method: "GET",
                    url: "/bot/volume?username=" + $('#user').val() + "&voiceChannelId=" + $('#channel').val()
                }).done(function (data) {
                    $('#volume').val(data);
                });
            });

            // Determine shown categories in navigation when windows get resized
            $(window).on('resize', determineShownNavigation);

            //Get lastReload initial
            $.ajax({
                method: "GET",
                url: "bot/lastReload"
            }).done(function (data) {
                console.log('Initial Reload Stamp ist ' + data);
                lastReload = data;
                intervalId = window.setInterval(function(){
                    $.ajax({
                        method: "GET",
                        url: "bot/lastReload"
                    }).done(function (data) {
                        if (data != lastReload){
                            console.log('New Reload Stamp ist ' + data);
                            lastReload = data;
                            clearInterval(intervalId)
                            $('#Modal').modal('show');
                        }
                    });
                }, 5000);
            });

            // Get sounds
            $.ajax({
                method: "GET",
                url: "api/soundFiles/findAll"
            }).done(function (data) {
                var top10ByDate = data.content;
                top10ByDate.sort(function (a, b) {
                    // Turn your strings into dates, and then subtract them
                    // to get a value that is either negative, positive, or zero.
                    return new Date(b.dateAdded) - new Date(a.dateAdded);
                });
                top10ByDate = top10ByDate.slice(0, 10);
                var soundObjects = data.content;
                soundObjects.sort(function (a, b) {
                    var textA = a.soundFileId.toUpperCase();
                    var textB = b.soundFileId.toUpperCase();
                    return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
                });
                var today = new Date();
                var lastWeek = Date.parse(new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7));
                $.each(soundObjects, function (i, obj) {
                    var recentClass = '';
                    var recentItem = top10ByDate.filter(e => e.soundFileId === obj.soundFileId);
                    if (recentItem.length > 0) {
                        if (lastWeek < Date.parse(recentItem[0].dateAdded)) {
                            recentClass = '<span class="recentBadge" title="Recently Added"></span>';
                        }
                    }
                    $('#sounds').append('<div id="' + obj.soundFileId + '" class="button btn btn-secondary m-1" class="btn btn-secondary m-1" data-category="' + obj.category + '"><span class="content">' + obj.soundFileId + '</span>' + recentClass + '</div>');
                });
            });

            // Get users


            // Get channels
            $.ajax({
                method: "GET",
                url: "/bot/channels"
            }).done(function (data) {
                $.each(data.sort(), function (i, obj) {
                    $('#user').append('<option value="' + obj.id + '"' + ((obj.defaultChannel) ? 'selected' : '') + '>' + obj.name + '</option>');
                });
            });

            // Get categories
            $.ajax({
                method: "GET",
                url: "api/soundFiles/categories"
            }).done(function (data) {
                $.each(data.sort(), function (i, obj) {
                    if (obj !== 'sounds') {
                        // Add to main navigation
                        $('#categories').append('<li class="nav-item"><a class="nav-link" href="#" data-category="' + obj + '">' + obj + '</a></li>');
                        // Add hidden to more-dropdown
                        $('#more .dropdown-menu').append('<a class="dropdown-item" href="#" data-category="' + obj + '" style="display:none;">' + obj + '</a>');
                    }
                });

                // Determine shown categories in navigation
                determineShownNavigation();
            });
        });
    </script>
</body>

</html>